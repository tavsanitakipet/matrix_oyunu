import random
import time
import os
import winsound

# === KRÄ°TÄ°K HATA YAKALAMA Ã‡EVRESÄ° ===
try:
    os.system('') 
except Exception as e:
    pass 
    
# === RENKLER ===
GREEN = "\033[92m"
CYAN = GREEN  
YELLOW = GREEN 
RED = GREEN   
BLUE = GREEN  
RESET = "\033[0m"
DEFAULT_COLOR = GREEN 

# === SES YOLU KONTROLÃœ ===
SOUND_PATH = r"C:\Users\enfan\OneDrive\MasaÃ¼stÃ¼\matrix_game"

def play_sound(filename):
    """Belirtilen ses dosyasÄ±nÄ± gÃ¼venli bir ÅŸekilde oynatÄ±r."""
    path = os.path.join(SOUND_PATH, filename)
    
    try:
        winsound.PlaySound(path, winsound.SND_FILENAME | winsound.SND_ASYNC)
    except Exception as e:
        print(f"\n{GREEN}[!] Ses Ã§alÄ±namadÄ±: {filename}. Ses Yolu HatasÄ±: {e}{RESET}")

# (matrix_rain ve slow_print fonksiyonlarÄ± Ã¶nceki gÃ¼venli haliyle kalÄ±r)
def matrix_rain(duration=5):
    # ... (matrix_rain fonksiyonu)
    try:
        cols, rows = os.get_terminal_size().columns, os.get_terminal_size().lines
    except:
        cols, rows = 80, 24
        
    drops = [random.randint(0, rows) for _ in range(cols)]
    start = time.time()
    
    print("\033[H\033[J", end="") 

    while time.time() - start < duration:
        out = []
        for r in range(rows):
            line_chars = []
            for c in range(cols):
                if drops[c] == r:
                    line_chars.append(random.choice("01"))
                else:
                    line_chars.append(" ")
            out.append(GREEN + "".join(line_chars) + RESET)
            
        print("\033[H", end="") 
        print("\n".join(out))
        
        drops = [(d + 1) % rows for d in drops]
        time.sleep(0.05)
    
    print("\033[H\033[J", end="") 

def slow_print(text, delay=0.03, color=DEFAULT_COLOR, rabbit_code=False):
    # ... (slow_print fonksiyonu)
    try:
        delay = float(delay)
    except:
        delay = 0.03
    
    rabbit_symbol = f"{GREEN}ðŸ°{RESET}"
    rabbit_text = "R4bb1t_H0l3" 
    
    if rabbit_code and random.random() < 0.08: 
        split_point = random.randint(len(text) // 4, len(text) * 3 // 4)
        for ch in str(text)[:split_point]:
            print(f"{color}{ch}{RESET}", end='', flush=True)
            time.sleep(delay)
            
        print("\n\n" + rabbit_symbol + f" {GREEN}{rabbit_text}{RESET} " + rabbit_symbol)
        time.sleep(1.5)
        print() 
        print(f"{GREEN}>> {RESET}", end='', flush=True) 
        
        for ch in str(text)[split_point:]:
            print(f"{color}{ch}{RESET}", end='', flush=True)
            time.sleep(delay)
    
    else:
        for ch in str(text):
            print(f"{color}{ch}{RESET}", end='', flush=True)
            time.sleep(delay)
            
    print()


# === UZUN FÄ°LM SENARYOSU GÄ°RÄ°ÅžÄ° ===
def introduction_story():
    
    matrix_rain(5)
    
    slow_print("Saat 02:47. Klavyede uyuyakaldÄ±n. Bilgisayar ekranÄ±nda yanÄ±p sÃ¶nen tek kelime: UYAN.", 
               delay=0.04, color=GREEN)
    time.sleep(1.5)
    
    slow_print("Ekranda bir mesaj beliriyor: 'TavÅŸan deliÄŸini takip et.' Kalp atÄ±ÅŸlarÄ±n hÄ±zlanÄ±yor. Birisi seni izliyor...", 
               delay=0.04, color=GREEN, rabbit_code=False)
    time.sleep(2)
    
    # Trinity ile KarÅŸÄ±laÅŸma
    slow_print("Neon Ä±ÅŸÄ±klarÄ±n aydÄ±nlattÄ±ÄŸÄ± bir kulÃ¼pte, Trinity seni buluyor. GÃ¶zlerinde derin bir bilgi var. 'Merhaba Thomas...' diyor.", 
               delay=0.04, color=GREEN)
    time.sleep(1.5)
    
    name = input(f"{GREEN}\n[Sorgu 1] GerÃ§ek adÄ±nÄ± sÃ¶yle. Kim olduÄŸunu hatÄ±rla: {RESET}")
    if not name:
        name = "Thomas Anderson"
        
    # Trinity ArtÄ±k Ä°simle Hitap Ediyor
    slow_print(f"Trinity: 'Sana Matrix'in ne olduÄŸunu sÃ¶yleyemem, {name}. GÃ¶rmen gerek.' Gizemli bir fÄ±sÄ±ltÄ±: 'Bir adam, Morpheus. Seni arÄ±yor.'", 
               delay=0.05, color=GREEN)
    play_sound("tavsan.wav")
    time.sleep(2)
    
    slow_print(f"Trinity: '{name}, takip et beni.'", color=GREEN, delay=0.03) 
    time.sleep(1)
    
    return name

# === ARA HÄ°KAYE 1: AJANLARDAN UZUN KAÃ‡IÅž VE Ä°NFAZ CEZASI ===
def escape_sequence(name):
    """Trinity'nin yÃ¶nlendirmesiyle uzun kaÃ§Ä±ÅŸ sahnesi. YanlÄ±ÅŸ cevap infazla sonlanÄ±r."""
    print("\n" + "="*50)
    slow_print(f"KapÄ± Ã§alÄ±nÄ±yor. Ajan Smith! Trinity fÄ±sÄ±ldÄ±yor: 'KoÅŸ! Ä°lk kapÄ±dan Ã§Ä±k ve benim sÃ¶ylediklerimi yap!'", color=GREEN, delay=0.04)
    time.sleep(1)
    
    slow_print("Morpheus telefonda: 'Korkmuyorsun, deÄŸil mi, Neo? Sadece gerÃ§eÄŸi gÃ¶rene kadar.'", color=GREEN, delay=0.04)
    play_sound("hata1.wav")
    
    # --- KARAR NOKTASI 1: KAÃ‡IÅž YOLU ---
    slow_print("\nKoridorun sonunda sol tarafta dar bir merdiven, saÄŸ tarafta ise eski, paslÄ± bir havalandÄ±rma giriÅŸi var.", color=GREEN, delay=0.05)
    slow_print(f"Trinity: '{name}, Ajanlar merdivenleri tahmin eder. Risk al!'", color=GREEN, delay=0.04)
    choice1 = input(f"{GREEN}Hangi yolu seÃ§iyorsun? (merdiven/havalandÄ±rma): {RESET}").lower().strip()
    
    if choice1 == "merdiven":
        slow_print("YanlÄ±ÅŸ seÃ§im! Merdivenler tÄ±kalÄ±. Ajan Smith'in botlarÄ±nÄ±n sesi yaklaÅŸÄ±yor!", color=GREEN, delay=0.05)
        run_ending(name, "SMITH") # Erken infaz sonu
        return False
    else:
        slow_print("HavalandÄ±rmaya sÃ¼rÃ¼ndÃ¼n. BaÅŸardÄ±n. Trinity: 'Ä°yi iÅŸ. Ama iÃ§erisi dar ve karanlÄ±k.'", color=GREEN, delay=0.05)
        play_sound("dogru.wav")
        time.sleep(0.5)

    # --- KARAR NOKTASI 2: SAKLANMA MI, DEVAM MI? ---
    slow_print("\nHavalandÄ±rma borusunun keskin bir kÃ¶ÅŸesindesin. DÄ±ÅŸarÄ±dan AjanlarÄ±n fÄ±sÄ±ltÄ±larÄ± geliyor. Bir sÃ¼re burada bekleyebilirsin, ya da ilerlemeye devam edebilirsin.", color=GREEN, delay=0.05)
    slow_print(f"Morpheus: 'ZamanÄ±n yok, {name}. Durmak Matrix'in sana ulaÅŸmasÄ± demektir!'", color=GREEN, delay=0.04)
    choice2 = input(f"{GREEN}Ne yapÄ±yorsun? (saklan/ilerle): {RESET}").lower().strip()
    
    if choice2 == "saklan":
        slow_print("DuraksadÄ±n. Ajan Smith, metal boruya vurarak yerini tespit etti! Boru patladÄ±!", color=RED, delay=0.05)
        run_ending(name, "SMITH") # Erken infaz sonu
        return False
    else:
        slow_print("Ä°lerlemeye devam ettin. Hava borusunun sonu, seni bir Ã§amaÅŸÄ±rhanenin Ã§atÄ±sÄ±na fÄ±rlatÄ±yor.", color=GREEN, delay=0.05)
        play_sound("dogru.wav")
        time.sleep(0.5)
        
    # --- KARAR NOKTASI 3: Ã‡ATI ATLAMA SAHNESÄ° ---
    slow_print("\nBÃ¼yÃ¼k bir Ã§atÄ±nÄ±n kenarÄ±ndasÄ±n. KarÅŸÄ±ndaki binaya atlamalÄ±sÄ±n. Mesafeyi hesaplamak zor.", color=GREEN, delay=0.05)
    slow_print(f"Trinity: 'Atlamak zorundasÄ±n, {name}! Atla!' Sen tereddÃ¼t ediyorsun... Ve Ajanlar yaklaÅŸÄ±yor.", color=GREEN, delay=0.04)
    choice3 = input(f"{GREEN}Atla mÄ±? (e/h): {RESET}").lower().strip()
    
    if choice3 == "e":
        slow_print("AtladÄ±n! Kodu kÄ±rdÄ±n. DÃ¼ÅŸÃ¼ÅŸ yerine, kendini bir aracÄ±n iÃ§inde buluyorsun. Kurtuldun!", color=GREEN, delay=0.05)
        play_sound("dogru.wav")
        time.sleep(0.5)
        print("="*50 + "\n")
        return True # BaÅŸarÄ±lÄ± kaÃ§Ä±ÅŸ
    else:
        slow_print("TereddÃ¼t ettin. Smith arkanda beliriyor. 'Geri dÃ¶nÃ¼yoruz, Anderson...' KaÃ§Ä±ÅŸ yok.", color=RED, delay=0.05)
        run_ending(name, "SMITH") # Erken infaz sonu
        return False

# === ARA HÄ°KAYE 2: MORPHEUS Ä°LE TANIÅžMA ===
def morpheus_meeting(name):
    """Morpheus ile ilk tanÄ±ÅŸma ve hap seÃ§imi sahnesi."""
    
    play_sound("giris.wav")
    
    slow_print(f"\nArtÄ±k araÃ§ta deÄŸilsin. EtrafÄ±nda metal, kablolar ve duman var. BurasÄ± Nebuchadnezzar.", color=GREEN, delay=0.04)
    slow_print("Uzun, siyah bir trenÃ§kotlu adam sana dÃ¶nÃ¼yor. 'Ben Morpheus. SeÃ§ilmiÅŸ KiÅŸiyi aradÄ±m. Seni buldum.'", color=GREEN, delay=0.05)
    time.sleep(2)
    
    slow_print("Morpheus: 'Bana gerÃ§eÄŸe inanÄ±p inanmayacaÄŸÄ±nÄ± bilmek iÃ§in buradasÄ±n.'", color=GREEN, delay=0.05)
    time.sleep(1)
    
    play_sound("hap.wav")
    slow_print("\nÃ–nÃ¼nde iki hap beliriyor. Morpheus devam ediyor:", color=GREEN, rabbit_code=False)
    slow_print("ðŸ”´ KÄ±rmÄ±zÄ± hap â†’ Kal, gerÃ§eÄŸi Ã¶ÄŸren, kodun efendisi ol. (MATRIX'ten UyanÄ±ÅŸ)", color=GREEN)
    slow_print("ðŸ”µ Mavi hap â†’ Git, uyu, her ÅŸey rÃ¼ya kalsÄ±n, acÄ± sona ersin. (UnutuÅŸ)", color=BLUE)


# === FELSEFÄ° BÄ°LMECELER ===
questions = [
    {"q": "1ï¸âƒ£ BilinÃ§altÄ±nÄ±n kaÃ§Ä±ÅŸ dÃ¶ngÃ¼sÃ¼nÃ¼, yani Matrix'in en zayÄ±f noktasÄ±nÄ± temsil eden kavram nedir? (Ã–zgÃ¼r Ä°rade/Duygular)", "a": "duygular"},
    {"q": "2ï¸âƒ£ Morpheus'un gemisinin adÄ±, 'RÃ¼yalarÄ±ndaki tanrÄ±larla buluÅŸanlarÄ±n rÃ¼yasÄ±' anlamÄ±na gelen hangi antik kaynaktan gelir? (Seraph/Nebuchadnezzar)", "a": "nebuchadnezzar"},
    {"q": "3ï¸âƒ£ Matrix'i kuran, dÃ¼zeni ve dÃ¶ngÃ¼yÃ¼ koruyan, 'Ä°nsanlarÄ±n %99.9'u yalanÄ± kabul eder' diyen program kimdir? (Mimar/Oracle)", "a": "mimar"},
    {"q": "4ï¸âƒ£ Matrix'teki gerÃ§eklik illÃ¼zyonunu korumakla gÃ¶revli, kodun kiÅŸileÅŸmiÅŸ hali olan tehditler kimlerdir? (Ajanlar/Botlar)", "a": "ajanlar"}
]

# === SONLANDIRMA FONKSÄ°YONU ===
def run_ending(name, ending_type):
    """Belirtilen sona gÃ¶re hikayeyi sonlandÄ±rÄ±r."""
    print("\n" * 3)
    
    if ending_type == "SMITH": 
        time.sleep(2) 
        
        # Hata Sesi ve Ä°nfaz DetaylarÄ±
        play_sound("hata1.wav") # Ä°stenen hata sesi
        
        slow_print(f"AJAN SMITH: 'Ã–zgÃ¼r irade illÃ¼zyonuna inanmak bÃ¼yÃ¼k bir hata, {name}. Kodun temizlenmesi gerekiyor.'", color=RED)
        slow_print("KurÅŸunlar vurdu. GerÃ§eklik parÃ§alandÄ±. Zihninin her satÄ±rÄ± silindi. Matrix'teki son anÄ±n.", color=RED)
            
        slow_print("ArtÄ±k sen de sistemin bir parÃ§asÄ±sÄ±n. Yeni bir Ajan doÄŸdu.", color=GREEN)
        slow_print("\n" * 2)
        slow_print(f"{RED}--- SON 4: AJAN SMITH Ä°STÄ°LASI / Ä°NFAZ ---{RESET}", color=RED, delay=0.08)
        
    elif ending_type == "KURTULUS": 
        play_sound("final_kurtulus.wav")
        slow_print(f"Kod Ã§Ã¶zÃ¼ldÃ¼! Mimar'Ä±n Ã§aresiz Ã§Ä±ÄŸlÄ±klarÄ± duyuluyor. Zion'a giden kapÄ± aÃ§Ä±k. {name}, sen SeÃ§ilmiÅŸ KiÅŸi'sin.", color=GREEN)
        slow_print("Ajanlar toza dÃ¶nÃ¼ÅŸtÃ¼. Trinity ve Morpheus seni bekliyor. ProgramÄ±n sonuna geldin.", color=GREEN)
        slow_print("ArtÄ±k yaÄŸmur olarak dÃ¼ÅŸen kodlarÄ± durdurabilirsin.", color=GREEN)
        slow_print("\n" * 2)
        slow_print(f"{GREEN}--- SON 2: ZION'A KURTULUÅž ---{RESET}", color=GREEN, delay=0.08)
        
    elif ending_type == "ANLASMA": 
        play_sound("final_mimar.wav")
        slow_print(f"Yeterince kod Ã§Ã¶zdÃ¼n ama tam deÄŸil. Mimar karÅŸÄ±na Ã§Ä±kÄ±yor.", color=GREEN)
        slow_print(f"'{name}, bir uzlaÅŸma yapalÄ±m.' Matrix, dengesini korudu. Sen ve sevdiklerin rahatsÄ±nÄ±z, ama savaÅŸ devam edecek...", color=GREEN)
        slow_print("Sen artÄ±k 'AnlaÅŸmacÄ±'sÄ±n. Dengeyi koruyan kiÅŸi. Ne tutsak, ne tam Ã¶zgÃ¼r.", color=GREEN)
        slow_print("\n" * 2)
        slow_print(f"{GREEN}--- SON 3: MÄ°MAR Ä°LE ANLAÅžMA ---{RESET}", color=GREEN, delay=0.08)
    
    elif ending_type == "UYKUCU":
        play_sound("final_uyku.wav")
        print("\n" * 2)
        slow_print("GÃ¶zlerin aÄŸÄ±rlaÅŸÄ±yor... Terminaldeki kodlar bulanÄ±klaÅŸÄ±yor...", color=GREEN)
        slow_print(f"Matrix seni nazikÃ§e yataÄŸÄ±na geri yatÄ±rÄ±yor. {name} yoktu, Thomas Anderson vardÄ±.", color=GREEN)
        slow_print("Bu rÃ¼yayÄ± hatÄ±rlamayacaksÄ±n. AlarmÄ±n Ã§alacak ve iÅŸe gideceksin. Her ÅŸey yolunda...", color=GREEN)
        slow_print("\n" * 2)
        slow_print(f"{GREEN}--- SON 1: UYKU VE UNUTUÅž ---{RESET}", color=GREEN, delay=0.08)
    
    slow_print("\nOyun bitti.", color=GREEN)


# === ANA OYUN ===
def main():
    
    try:
        name = introduction_story()
    except Exception as e:
        print(f"{GREEN}\nKRÄ°TÄ°K HATA! GiriÅŸ sÄ±rasÄ±nda beklenmedik hata: {e}{RESET}")
        return

    # Kovalama sahnesi Ã§alÄ±ÅŸÄ±r, baÅŸarÄ±sÄ±z olursa oyun run_ending iÃ§inde biter ve False dÃ¶ner.
    if not escape_sequence(name):
        return # Erken bitiÅŸ

    morpheus_meeting(name)
    
    choice = input(f"{GREEN}SeÃ§imin ne? (k/m): {RESET}").lower().strip()

    if choice == "m":
        run_ending(name, "UYKUCU")
        return
    else:
        slow_print("KÄ±rmÄ±zÄ± hap yutuldu... VÃ¼cudun titriyor. GerÃ§eklik parÃ§alanÄ±yor.", color=GREEN)
        play_sound("tavsan.wav") 
        slow_print(f"\n**[MESAJ: Kodlar seni kabul etti. Åžimdi gerÃ§ek Matrix'i gÃ¶rme zamanÄ±.]**{RESET}", color=GREEN, delay=0.05)
        time.sleep(2)

    # === SORULAR VE HATA KONTROLÃœ ===
    score = 0
    error_count = 0 
    
    for i, q in enumerate(questions, 1):
        
        if error_count >= 3:
            time.sleep(1) 
            slow_print(f"\n{RED}KRÄ°TÄ°K HATA: {error_count} yanlÄ±ÅŸ cevap! Ajanlar seni yakaladÄ± ve sisteme entegre ediyor...{RESET}", color=RED)
            run_ending(name, "SMITH") # KÃ¶tÃ¼ son (Smith)
            return 
            
        print("\n" + "="*30)
        slow_print(q["q"], color=GREEN, rabbit_code=False) 
        ans = input(f"{GREEN}CevabÄ±n: {RESET}").lower().strip()
        
        if ans == q["a"]:
            play_sound("dogru.wav")
            time.sleep(0.5) 
            slow_print("DoÄŸru... Bir kod daha Ã§Ã¶zÃ¼ldÃ¼. Matrix'teki etkinliÄŸin artÄ±yor.", color=GREEN)
            score += 1
        else:
            error_count += 1
            sound_index = min(error_count, 3) 
            play_sound(f"hata{sound_index}.wav")
            
            if error_count == 3:
                 time.sleep(1.5) 
                 
            slow_print("YanlÄ±ÅŸ! Sistem seni fark etti. Ajanlar sana yaklaÅŸÄ±yor.", color=GREEN)
            time.sleep(1)

    # === SONLAR ===
    
    if error_count >= 3:
        run_ending(name, "SMITH")
    elif score == len(questions): 
        run_ending(name, "KURTULUS")
    elif 2 <= score < len(questions): 
        run_ending(name, "ANLASMA")
    else: 
        run_ending(name, "SMITH")
        

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print(f"\n{RED}GENEL KRÄ°TÄ°K HATA! Kod beklenmedik bir ÅŸekilde durdu. Hata mesajÄ±: {e}{RESET}")
    finally:
        # Hata olsa da olmasa da terminalin kapanmasÄ±nÄ± engelle
        input(f"\n{GREEN}Oyun bitti. Kapatmak iÃ§in ENTER tuÅŸuna basÄ±nÄ±z...{RESET}")